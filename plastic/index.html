<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Plastic Detector</title>
		<style>
			:root {
				--bg-color: #1a1a1a;
				--card-bg: #2d2d2d;
				--text-color: #e0e0e0;
				--accent: #4caf50;
				--accent-hover: #45a049;
				--border: #444;
				--code-bg: #111;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background-color: var(--bg-color);
				color: var(--text-color);
				margin: 0;
				padding: 20px;
				display: flex;
				justify-content: center;
			}

			.container {
				width: 100%;
				max-width: 800px;
				background-color: var(--card-bg);
				padding: 30px;
				border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
			}

			h1,
			h2 {
				margin-top: 0;
				color: #fff;
			}

			.section {
				margin-bottom: 25px;
				padding-bottom: 20px;
				border-bottom: 1px solid var(--border);
			}

			label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
				font-size: 0.9rem;
				color: #aaa;
			}

			input[type="text"],
			input[type="password"],
			textarea,
			select {
				width: 100%;
				padding: 10px;
				background-color: #3d3d3d;
				border: 1px solid var(--border);
				border-radius: 6px;
				color: #fff;
				box-sizing: border-box;
				margin-bottom: 10px;
				font-family: monospace;
			}

			textarea {
				resize: vertical;
				min-height: 60px;
			}

			.row {
				display: flex;
				gap: 15px;
			}

			.col {
				flex: 1;
			}

			button {
				background-color: var(--accent);
				color: white;
				padding: 12px 20px;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 1rem;
				transition: background 0.2s;
			}

			button:hover {
				background-color: var(--accent-hover);
			}

			button:disabled {
				background-color: #555;
				cursor: not-allowed;
			}

			button.secondary {
				background-color: #555;
				font-size: 0.8rem;
				padding: 8px 12px;
			}

			button.secondary:hover {
				background-color: #666;
			}

			button.camera-btn {
				background-color: #2196F3;
			}

			button.camera-btn:hover {
				background-color: #1e88e5;
			}

			button.cancel-btn {
				background-color: #f44336;
			}

			button.cancel-btn:hover {
				background-color: #d32f2f;
			}

			.image-preview-container {
				text-align: center;
				margin: 20px 0;
				min-height: 250px;
				border: 2px dashed var(--border);
				border-radius: 8px;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				position: relative;
				background-color: #252525;
				overflow: hidden;
			}

			#imagePreview,
			#cameraStream {
				max-width: 100%;
				max-height: 400px;
				display: none;
				border-radius: 4px;
			}

			.upload-placeholder {
				color: #888;
			}

			input[type="file"] {
				display: none;
			}

			.input-actions {
				display: flex;
				gap: 10px;
				margin-top: 10px;
			}

			.upload-btn,
			.cam-toggle-btn {
				display: inline-block;
				background-color: #3d3d3d;
				padding: 10px 15px;
				border-radius: 6px;
				cursor: pointer;
				border: 1px solid var(--border);
				text-align: center;
				color: var(--text-color);
				font-size: 0.9rem;
				user-select: none;
			}

			.upload-btn:hover,
			.cam-toggle-btn:hover {
				background-color: #4d4d4d;
			}

			/* Camera controls overlaid or below */
			#cameraControls {
				display: none;
				margin-top: 10px;
				gap: 10px;
			}

			#output-area {
				display: none;
				margin-top: 20px;
			}

			.result-box {
				padding: 15px;
				border-radius: 8px;
				text-align: center;
				font-size: 1.5rem;
				font-weight: bold;
				margin-bottom: 10px;
			}

			.timing-info {
				text-align: center;
				color: #888;
				font-size: 0.85rem;
				margin-bottom: 15px;
				font-family: monospace;
			}

			.is-plastic {
				background-color: rgba(76, 175, 80, 0.2);
				color: #4caf50;
				border: 1px solid #4caf50;
			}

			.not-plastic {
				background-color: rgba(244, 67, 54, 0.2);
				color: #f44336;
				border: 1px solid #f44336;
			}

			.error-result {
				background-color: rgba(255, 152, 0, 0.2);
				color: #ff9800;
				border: 1px solid #ff9800;
			}

			pre {
				background-color: var(--code-bg);
				padding: 15px;
				border-radius: 6px;
				overflow-x: auto;
				font-size: 0.85rem;
				color: #a5d6a7;
				border: 1px solid #333;
			}

			.loading {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 3px solid rgba(255, 255, 255, .3);
				border-radius: 50%;
				border-top-color: #fff;
				animation: spin 1s ease-in-out infinite;
				margin-right: 10px;
				vertical-align: middle;
			}

			/* New Styles for Sliders */
			.slider-container {
				background-color: #333;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 15px;
				border: 1px solid var(--border);
			}
			
			.slider-row {
				display: flex;
				align-items: center;
				gap: 15px;
				margin-bottom: 10px;
			}

			.slider-row:last-child {
				margin-bottom: 0;
			}

			.slider-label {
				flex: 1;
				font-size: 0.85rem;
				color: #ccc;
			}

			.slider-input {
				flex: 2;
			}

			input[type=range] {
				width: 100%;
				accent-color: var(--accent);
			}

			.image-stats {
				font-size: 0.8rem;
				color: #888;
				text-align: right;
				margin-top: 5px;
				font-family: monospace;
			}

			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}
		</style>
	</head>

	<body>

		<div class="container">
			<h1>Plastic Detector</h1>

			<!-- Settings Section -->
			<div class="section">
				<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
					<h2>API Configuration</h2>
				</div>

				<div class="row">
					<div class="col">
						<label for="apiUrl">API URL</label>
						<input type="text" id="apiUrl" placeholder="https://generativelanguage.googleapis.com/...">
					</div>
					<div class="col">
						<label for="modelName">Model Name</label>
						<input type="text" id="modelName" placeholder="gemini-2.5-flash-lite">
					</div>
				</div>
				<label for="apiKey">API Key</label>
				<input type="password" id="apiKey" placeholder="API Key">
			</div>

			<!-- Prompts Section -->
			<div class="section">
				<div style="display:flex; justify-content:space-between; align-items:center;">
					<h2>Prompts</h2>
					<button class="secondary" onclick="resetPrompts()">Reset Defaults</button>
				</div>
				<label for="sysPrompt">System Prompt</label>
				<textarea id="sysPrompt"></textarea>

				<label for="userPrompt">User Prompt</label>
				<textarea id="userPrompt"></textarea>
			</div>

			<!-- Image Input Section -->
			<div class="section" style="border-bottom: none;">
				<h2>Image Source</h2>

				<div class="input-actions">
					<label for="imageInput" class="upload-btn">üìÇ Upload File</label>
					<div class="cam-toggle-btn" onclick="startCamera()">üì∑ Use Camera</div>
				</div>

				<input type="file" id="imageInput" accept="image/*">

				<!-- Preview & Camera Area -->
				<div class="image-preview-container" id="dropZone">
					<span class="upload-placeholder">No image selected</span>

					<!-- Static Image Preview -->
					<img id="imagePreview" alt="Preview">

					<!-- Live Camera Stream -->
					<video id="cameraStream" autoplay playsinline></video>
				</div>

				<!-- Optimization Sliders (New) -->
				<div class="slider-container" id="optControls" style="display:none;">
					<label style="color:#fff; border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:10px;">Image Optimization</label>
					
					<div class="slider-row">
						<div class="slider-label">Max Resolution: <span id="resVal">1024</span>px</div>
						<div class="slider-input">
							<input type="range" id="resolutionSlider" min="256" max="2048" step="64" value="1024">
						</div>
					</div>

					<div class="slider-row">
						<div class="slider-label">JPEG Quality: <span id="qualVal">0.8</span></div>
						<div class="slider-input">
							<input type="range" id="qualitySlider" min="0.1" max="1.0" step="0.05" value="0.8">
						</div>
					</div>
					<div id="fileSizeStat" class="image-stats">Estimated Size: 0 KB</div>
				</div>

				<!-- Camera Actions (Only visible when camera is active) -->
				<div id="cameraControls" style="text-align:center;">
					<button type="button" class="camera-btn" onclick="captureImage()">Capture Photo</button>
					<button type="button" class="cancel-btn" onclick="stopCamera()">Cancel</button>
				</div>

				<button id="analyzeBtn" style="width:100%; margin-top:15px;" onclick="analyzeImage()" disabled>Analyze
					Image</button>
			</div>

			<!-- Results Section -->
			<div id="output-area">
				<h2>Result</h2>
				<div id="visualResult" class="result-box"></div>
				<div id="timingResult" class="timing-info"></div>

				<label>Raw JSON Response:</label>
				<pre id="jsonOutput"></pre>
			</div>
		</div>

		<!-- Hidden Canvas for capturing video frame -->
		<canvas id="canvas" style="display:none;"></canvas>

		<script>
			// --- Constants & Defaults ---
			const DEFAULT_API_URL = "https://generativelanguage.googleapis.com/v1beta/openai/chat/completions";
			const DEFAULT_MODEL = "gemini-2.5-flash-lite";

			const DEFAULT_SYS_PROMPT = "You are an object material classifier. Answer is just `true` if the object in the image is made out of plastic, otherwise `false`. Do not write anything else.";
			const DEFAULT_USER_PROMPT = "Is the object in this image made out of plastic? Answer `true` if so, otherwise `false`.";

			// --- State ---
			let rawImageSource = null; // Stores the original Image object
			let currentBase64Image = null; // Stores the compressed/resized Data URL
			let streamObj = null;

			// --- Initialization ---
			document.addEventListener('DOMContentLoaded', () => {
				loadSettings();

				const fileInput = document.getElementById('imageInput');
				fileInput.addEventListener('change', handleFileSelect);

				// Auto-save listeners
				['apiUrl', 'apiKey', 'modelName', 'sysPrompt', 'userPrompt'].forEach(id => {
					document.getElementById(id).addEventListener('input', saveSettings);
				});

				// Slider listeners
				document.getElementById('resolutionSlider').addEventListener('input', (e) => {
					document.getElementById('resVal').innerText = e.target.value;
					processImage();
				});

				document.getElementById('qualitySlider').addEventListener('input', (e) => {
					document.getElementById('qualVal').innerText = e.target.value;
					processImage();
				});
			});

			// --- Settings Management ---
			function loadSettings() {
				document.getElementById('apiUrl').value = localStorage.getItem('api_url') || DEFAULT_API_URL;
				document.getElementById('apiKey').value = localStorage.getItem('api_key') || '';
				document.getElementById('modelName').value = localStorage.getItem('api_model') || DEFAULT_MODEL;

				const savedSys = localStorage.getItem('sys_prompt');
				const savedUser = localStorage.getItem('user_prompt');

				document.getElementById('sysPrompt').value = savedSys !== null ? savedSys : DEFAULT_SYS_PROMPT;
				document.getElementById('userPrompt').value = savedUser !== null ? savedUser : DEFAULT_USER_PROMPT;
			}

			function saveSettings() {
				localStorage.setItem('api_url', document.getElementById('apiUrl').value);
				localStorage.setItem('api_key', document.getElementById('apiKey').value);
				localStorage.setItem('api_model', document.getElementById('modelName').value);
				localStorage.setItem('sys_prompt', document.getElementById('sysPrompt').value);
				localStorage.setItem('user_prompt', document.getElementById('userPrompt').value);
			}

			function resetPrompts() {
				if (confirm("Reset prompts to default?")) {
					document.getElementById('sysPrompt').value = DEFAULT_SYS_PROMPT;
					document.getElementById('userPrompt').value = DEFAULT_USER_PROMPT;
					saveSettings();
				}
			}

			// --- File Image Handling ---
			function handleFileSelect(evt) {
				// Ensure camera is off if selecting a file
				stopCameraStream();

				const file = evt.target.files[0];
				if (!file) return;

				const reader = new FileReader();
				reader.onload = function (e) {
					// Create an Image object to act as the raw source
					const img = new Image();
					img.onload = () => {
						rawImageSource = img;
						// Initial processing with default/current slider values
						processImage();
						
						// Show UI elements
						document.getElementById('cameraStream').style.display = 'none';
						document.getElementById('cameraControls').style.display = 'none';
						document.querySelector('.upload-placeholder').style.display = 'none';
						document.getElementById('optControls').style.display = 'block';
						document.getElementById('analyzeBtn').disabled = false;
						document.getElementById('output-area').style.display = 'none';
					};
					img.src = e.target.result;
				};
				reader.readAsDataURL(file);
			}

			// --- Core Image Processing (Resize & Compress) ---
			function processImage() {
				if (!rawImageSource) return;

				const canvas = document.createElement('canvas');
				const ctx = canvas.getContext('2d');

				// Get slider values
				const maxDim = parseInt(document.getElementById('resolutionSlider').value);
				const quality = parseFloat(document.getElementById('qualitySlider').value);

				// Calculate new dimensions
				let width = rawImageSource.width;
				let height = rawImageSource.height;

				if (width > height) {
					if (width > maxDim) {
						height *= maxDim / width;
						width = maxDim;
					}
				} else {
					if (height > maxDim) {
						width *= maxDim / height;
						height = maxDim;
					}
				}

				canvas.width = width;
				canvas.height = height;

				// Draw and resize
				ctx.drawImage(rawImageSource, 0, 0, width, height);

				// Compress to DataURL
				const processedDataUrl = canvas.toDataURL('image/jpeg', quality);
				
				// Update State
				currentBase64Image = processedDataUrl;

				// Update Preview
				const imgPreview = document.getElementById('imagePreview');
				imgPreview.src = processedDataUrl;
				imgPreview.style.display = 'block';

				// Update Size Estimate
				const sizeInBytes = Math.ceil((processedDataUrl.length - 22) * 0.75); // approx base64 size
				const sizeInKb = (sizeInBytes / 1024).toFixed(1);
				document.getElementById('fileSizeStat').innerText = 
					`Res: ${Math.round(width)}x${Math.round(height)} | Estimated Size: ${sizeInKb} KB`;
			}


			// --- Webcam Handling ---
			async function startCamera() {
				const vid = document.getElementById('cameraStream');
				const img = document.getElementById('imagePreview');
				const controls = document.getElementById('cameraControls');
				const placeholder = document.querySelector('.upload-placeholder');
				const analyzeBtn = document.getElementById('analyzeBtn');
				const optControls = document.getElementById('optControls');

				// Hide static image stuff
				img.style.display = 'none';
				optControls.style.display = 'none';
				placeholder.style.display = 'none';
				analyzeBtn.disabled = true;

				try {
					// Use environment (rear) camera if available, otherwise default
					streamObj = await navigator.mediaDevices.getUserMedia({
						video: { facingMode: "environment" }
					});

					vid.srcObject = streamObj;
					vid.style.display = 'block';
					controls.style.display = 'flex'; // Show capture/cancel buttons

				} catch (err) {
					console.error("Camera access error:", err);
					alert("Could not access camera. Please check permissions or use file upload.");
					stopCamera(); // Revert UI
				}
			}

			function captureImage() {
				const vid = document.getElementById('cameraStream');
				const canvas = document.getElementById('canvas');

				if (!streamObj) return;

				// Set canvas size to video size
				canvas.width = vid.videoWidth;
				canvas.height = vid.videoHeight;

				// Draw current video frame to canvas
				const ctx = canvas.getContext('2d');
				ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);

				// Capture full resolution first to memory
				const rawDataUrl = canvas.toDataURL('image/jpeg', 1.0);
				
				const img = new Image();
				img.onload = () => {
					rawImageSource = img;
					stopCameraStream(); // Turn off camera
					
					// Update UI
					document.getElementById('cameraStream').style.display = 'none';
					document.getElementById('cameraControls').style.display = 'none';
					document.getElementById('optControls').style.display = 'block';
					document.getElementById('analyzeBtn').disabled = false;
					
					// Run initial process
					processImage();
				};
				img.src = rawDataUrl;
			}

			function stopCamera() {
				stopCameraStream();
				// Reset UI to empty state if no previous image existed, or keep previous logic
				document.getElementById('cameraStream').style.display = 'none';
				document.getElementById('cameraControls').style.display = 'none';

				if (currentBase64Image) {
					document.getElementById('imagePreview').style.display = 'block';
					document.getElementById('optControls').style.display = 'block';
					document.getElementById('analyzeBtn').disabled = false;
				} else {
					document.querySelector('.upload-placeholder').style.display = 'block';
					document.getElementById('optControls').style.display = 'none';
				}
			}

			function stopCameraStream() {
				if (streamObj) {
					streamObj.getTracks().forEach(track => track.stop());
					streamObj = null;
				}
			}

			// --- API Logic ---
			async function analyzeImage() {
				const apiKey = document.getElementById('apiKey').value;
				const apiUrl = document.getElementById('apiUrl').value;
				const model = document.getElementById('modelName').value;
				const sysPrompt = document.getElementById('sysPrompt').value;
				const userPrompt = document.getElementById('userPrompt').value;

				if (!apiKey) {
					alert("Please enter an API Key.");
					return;
				}

				const btn = document.getElementById('analyzeBtn');
				const originalBtnText = btn.innerHTML;
				btn.innerHTML = '<span class="loading"></span> Analyzing...';
				btn.disabled = true;

				// UI Prep
				document.getElementById('output-area').style.display = 'block';
				document.getElementById('visualResult').className = 'result-box';
				document.getElementById('visualResult').innerHTML = 'Processing...';
				document.getElementById('jsonOutput').innerText = 'Waiting for response...';
				document.getElementById('timingResult').innerText = '';

				// --- TIMING START ---
				const startTime = performance.now();

				try {
					const payload = {
						model: model,
						reasoning_effort: "none",
						messages: [
							{ role: "system", content: sysPrompt },
							{
								role: "user",
								content: [
									{ type: "text", text: userPrompt },
									{ type: "image_url", image_url: { url: currentBase64Image } }
								]
							}
						],
						max_tokens: 1
					};

					const response = await fetch(apiUrl, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Authorization': `Bearer ${apiKey}`
						},
						body: JSON.stringify(payload)
					});

					const data = await response.json();

					// --- TIMING END ---
					const endTime = performance.now();
					const duration = (endTime - startTime).toFixed(0);
					document.getElementById('timingResult').innerText = `Request latency: ${duration} ms`;

					// Show Raw JSON
					document.getElementById('jsonOutput').innerText = JSON.stringify(data, null, 2);

					// Logic Interpretation
					if (data.error) {
						showResult("API ERROR: " + data.error.message, "error");
					} else if (data.choices && data.choices.length > 0) {
						const content = data.choices[0].message.content.trim().toLowerCase();

						if (content.includes("true")) {
							showResult("‚úÖ PLASTIC DETECTED", "true");
						} else if (content.includes("false")) {
							showResult("‚ùå NOT PLASTIC", "false");
						} else {
							showResult("‚ö†Ô∏è UNKNOWN: " + content, "error");
						}
					} else {
						showResult("‚ö†Ô∏è Unexpected API Response format", "error");
					}

				} catch (err) {
					console.error(err);
					document.getElementById('jsonOutput').innerText = err.toString();
					showResult("Network/Script Error", "error");
				} finally {
					btn.innerHTML = originalBtnText;
					btn.disabled = false;
				}
			}

			function showResult(text, type) {
				const box = document.getElementById('visualResult');
				box.innerText = text;
				box.className = 'result-box';

				if (type === 'true') box.classList.add('is-plastic');
				else if (type === 'false') box.classList.add('not-plastic');
				else box.classList.add('error-result');
			}
		</script>

	</body>

</html>